<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OUCT Covalent Partners - Alpha Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1a2a6c; --win: #27ae60; --loss: #e74c3c; --accent: #fdbb2d; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 20px; color: #333; }
        .dashboard { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .stat-card { 
            color: white; padding: 25px; border-radius: 15px; text-align: center; margin-bottom: 25px; 
            transition: background 1.5s ease; 
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .stat-card.gold { background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c); color: #1a2a6c; border: 1px solid #d4af37; }
        .winner-name { font-size: 2.5em; font-weight: 800; margin: 5px 0; }
        .chart-container { height: 400px; margin-bottom: 30px; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        th { text-align: left; padding: 12px; font-size: 0.8em; color: #888; text-transform: uppercase; border-bottom: 2px solid #eee; }
        td { padding: 15px 12px; border-bottom: 1px solid #f8f8f8; font-size: 1.1em; }
        .ticker { font-family: monospace; background: #f0f7ff; color: #007bff; padding: 4px 8px; border-radius: 5px; font-weight: bold; }
        .pos { color: var(--win); font-weight: bold; }
        .neg { color: var(--loss); font-weight: bold; }
        .rocket { margin-left: 8px; font-size: 1.2em; filter: drop-shadow(0 0 3px gold); }
        .benchmarks-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 10px; }
        .benchmark-card { background: #f8f9fa; border-radius: 12px; padding: 15px; border: 1px solid #edf2f7; text-align: center; }
        .avg-card { background: var(--primary); color: white; border: 1px solid var(--primary); }
        .avg-card .ticker { background: rgba(255,255,255,0.1); color: white; }
        .refresh-btn { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .section-2025 { margin-top: 60px; padding-top: 40px; border-top: 3px double #eee; }
    </style>
</head>
<body>
<div class="dashboard">
    <header>
        <h1>üß™ OUCT Covalent Partners</h1>
        <button class="refresh-btn" onclick="update()">üöÄ Update Live</button>
    </header>

    <div id="leader-card-2026"></div>

    <h2>Performance Since Jan 1, 2026</h2>
    <div class="chart-container">
        <canvas id="multiChart"></canvas>
    </div>

    <h2>2026 Leaderboard</h2>
    <div id="participant-area-2026">Connecting to your spreadsheet...</div>

    <h2>Market & Fund Benchmarks (2026)</h2>
    <div id="market-area" class="benchmarks-grid"></div>

    <div class="section-2025">
        <h1 style="text-align: center; color: #7f8c8d; margin-bottom: 30px;">üóìÔ∏è 2025 Performance</h1>
        <div id="champion-card-2025"></div>
        <h2>2025 Final Leaderboard</h2>
        <div id="participant-area-2025">Loading historical data...</div>
    </div>

    <div id="last-updated" style="text-align: center; margin-top: 40px; color: #bdc3c7; font-size: 0.8em;"></div>
</div>

<script>
    const SHEET_ID = '1sEP1zRqhjJqp_cuLvggNBjiPdjbrCpMr5DW-7rIBF_s';
    const GID_2026 = '1028487677';
    const GID_2025 = '869680458';
    const TAB_HISTORY = 'History';
    let chartObj = null;

    function getDynamicStyle(perf) {
        const intensity = Math.min(Math.abs(perf) / 0.15, 1);
        return perf >= 0 ? `linear-gradient(135deg, #1a2a6c, rgba(39, 174, 96, ${intensity}))` : `linear-gradient(135deg, #1a2a6c, rgba(231, 76, 60, ${intensity}))`;
    }

    async function update() {
        fetchYearData(GID_2026, '2026');
        fetchYearData(GID_2025, '2025');
        fetchHistory();
        document.getElementById('last-updated').innerText = "Last Updated: " + new Date().toLocaleTimeString();
    }

    async function fetchYearData(gid, year) {
        try {
            const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`);
            const text = await res.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            const rows = json.table.rows;
            let participants = [];
            let benchmarks = [];
            let sp500Perf = -999;

            rows.forEach((r) => {
                if(r.c && r.c[0] && r.c[1]) {
                    const name = r.c[0].v || "";
                    const ticker = r.c[1].v || "";
                    if(ticker === 'Ticker' || name === 'Participant') return;

                    if (year === '2026') {
                        const price = r.c[3] ? (r.c[3].f || r.c[3].v) : '0';
                        const perfRaw = r.c[4] ? r.c[4].v : 0;
                        const item = { name, ticker, price, perfRaw, perfDisp: (perfRaw * 100).toFixed(2) + '%' };
                        if (participants.length < 10) participants.push(item);
                        else {
                            benchmarks.push(item);
                            if (name.toUpperCase().includes("S&P") || ticker.includes("INX")) sp500Perf = perfRaw;
                        }
                    } else {
                        const ongoingRaw = r.c[4] ? r.c[4].v : 0;
                        const finalRaw = r.c[5] ? r.c[5].v : 0;
                        participants.push({ name, ticker, ongoing: (ongoingRaw * 100).toFixed(2) + '%', final: (finalRaw * 100).toFixed(2) + '%', finalValue: finalRaw });
                    }
                }
            });

            if (year === '2026') {
                participants.sort((a, b) => b.perfRaw - a.perfRaw);
                render2026(participants, benchmarks, sp500Perf);
            } else {
                participants.sort((a, b) => b.finalValue - a.finalValue);
                render2025(participants);
            }
        } catch (e) { console.error(e); }
    }

    function render2026(participants, benchmarks, sp500Perf) {
        const totalPerf = participants.reduce((sum, p) => sum + p.perfRaw, 0);
        const avgPerf = totalPerf / participants.length;
        const leader = participants[0];
        document.getElementById('leader-card-2026').innerHTML = `<div class="stat-card" style="background: ${getDynamicStyle(leader.perfRaw)}"><div style="text-transform: uppercase; font-size: 0.8em; letter-spacing: 2px;">2026 Leader</div><div class="winner-name">üëë ${leader.name}</div><div style="font-size:1.2em; color:var(--accent); font-weight: bold;">${leader.ticker} ‚Ä¢ ${leader.perfDisp}</div></div>`;
        let pTable = `<table><tr><th>#</th><th>Name</th><th>Ticker</th><th style="text-align:right">Price</th><th style="text-align:right">Gain</th></tr>`;
        participants.forEach((p, i) => { pTable += `<tr><td>#${i+1}</td><td><strong>${p.name}</strong>${p.perfRaw > sp500Perf ? '<span class="rocket">üöÄ</span>' : ''}</td><td><span class="ticker">${p.ticker}</span></td><td style="text-align:right">$${p.price}</td><td style="text-align:right" class="${p.perfRaw >= 0 ? 'pos' : 'neg'}">${(p.perfRaw > 0 ? '+' : '') + p.perfDisp}</td></tr>`; });
        document.getElementById('participant-area-2026').innerHTML = pTable + `</table>`;
        let mHtml = benchmarks.map(b => `<div class="benchmark-card"><div style="font-weight:700;">${b.name}</div><div class="${b.perfRaw >= 0 ? 'pos' : 'neg'}">${(b.perfRaw > 0 ? '+' : '') + b.perfDisp}</div></div>`).join('');
        mHtml += `<div class="benchmark-card avg-card"><div style="font-weight:700;">Group Average</div><div class="ticker" style="font-size:0.75em; margin: 4px 0;">Fund Mean</div><div style="font-size:1.2em; font-weight:bold;">${(avgPerf > 0 ? '+' : '') + (avgPerf * 100).toFixed(2)}%</div></div>`;
        document.getElementById('market-area').innerHTML = mHtml;
    }

    function render2025(participants) {
        const champion = participants[0];
        document.getElementById('champion-card-2025').innerHTML = `<div class="stat-card gold"><div style="text-transform: uppercase; font-size: 0.8em; letter-spacing: 2px; font-weight: bold;">üèÜ 2025 Champion</div><div class="winner-name">${champion.name}</div><div style="font-size:1.2em; font-weight: bold;">Final Performance: ${champion.final}</div></div>`;
        let html = `<table><tr><th>Rank</th><th>Participant</th><th>Ticker</th><th style="text-align:right">Ongoing Performance</th><th style="text-align:right">Final Performance</th></tr>`;
        participants.forEach((p, i) => { html += `<tr><td style="font-weight: bold; color: #7f8c8d;">#${i+1}</td><td><strong>${p.name}</strong></td><td><span class="ticker">${p.ticker}</span></td><td style="text-align:right">${p.ongoing}</td><td style="text-align:right; font-weight: bold;" class="${p.finalValue >= 0 ? 'pos' : 'neg'}">${p.final}</td></tr>`; });
        document.getElementById('participant-area-2025').innerHTML = html + `</table>`;
    }

    async function fetchHistory() {
        try {
            const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${TAB_HISTORY}`);
            const text = await res.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            const rows = json.table.rows;
            const cols = json.table.cols;
            if (!rows || rows.length === 0) return;
            const labels = rows.map(r => r.c[0]?.f || '');
            const colors = ['#1a2a6c', '#b21f1f', '#fdbb2d', '#27ae60', '#3498db', '#9b59b6', '#e67e22', '#1abc9c', '#2c3e50', '#7f8c8d'];
            const datasets = [];
            for (let i = 1; i < cols.length; i++) {
                if (!cols[i] || !cols[i].label) continue;
                const cleanLabel = cols[i].label.toString().replace(/Close/gi, "").trim();
                const tickerData = rows.map(r => {
                    const val = r.c[i]?.v;
                    const firstVal = rows[0].c[i]?.v;
                    return (firstVal && val) ? ((val - firstVal) / firstVal) * 100 : 0;
                });
                datasets.push({ label: cleanLabel, data: tickerData, borderColor: colors[i-1] || '#ccc', borderWidth: cleanLabel.toUpperCase().includes("S&P") ? 4 : 2, fill: false, tension: 0.1, pointRadius: 0 });
            }
            const ctx = document.getElementById('multiChart').getContext('2d');
            if (chartObj) chartObj.destroy();
            chartObj = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } }, scales: { y: { ticks: { callback: v => v.toFixed(1) + '%' } } } } });
        } catch (e) { console.error(e); }
    }
    update();
</script>
</body>
</html>
